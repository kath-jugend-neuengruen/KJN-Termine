<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beitrittserklärung KJN</title>
<link rel="icon" href="https://scontent-fra3-2.xx.fbcdn.net/v/t39.30808-6/326392531_1839055796475810_667497308983715319_n.png?_nc_cat=104&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=7G_9qMTB1mAQ7kNvgGRN6cu&_nc_zt=23&_nc_ht=scontent-fra3-2.xx&_nc_gid=AMDSnmzYKIgqbzUe2EpszIc&oh=00_AYA5Wtm2NQY_4inKYNbiFh-qbowyM0iaFlwN8CutDt8gYA&oe=67209A4B" type="image/x-icon">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
           
            margin: 0;
 	    overflow: auto;
            background-color: #f5f5f5;
        }
.scrollable-text {
            width: 96%;
            max-width: 100%;
            height: 100px;
	    margin:0 auto;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            resize: none;
            overflow-y: scroll;
            font-size: 10px;
        }
        h1 {
            font-size: 30px;
            margin-bottom: 10px;
	    text-align: center;
        }
        form {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }

 @media (max-width: 768px) {  /* Für Geräte mit einer Bildschirmbreite von 768px oder kleiner */
        form {
            width: 90%; /* Setzt die Breite des Formulars auf 90% der Bildschirmbreite */
        }
 .signature-container {
            width: 90%; /* Mobilgerätebreite auf 90% */
        }
    }

        .form-group {
            margin-bottom: 15px;
 	width: 100%;
        max-width: 90%; /* Begrenzung auf 90% der Displaybreite */
        margin: 0 auto;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input, textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

	 .button-containers {
            display: flex;
            justify-content: center;
            align-items: center;
	    margin-bottom:20px;
            height: 100%; /* Nimmt die gesamte Höhe ein */
        }

        .download-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }

        .download-button:hover {
            background-color: #0056b3;
        }  
.button-container {
    display: flex; /* Verwenden von Flexbox */
    flex-wrap: wrap; /* Erlaubt Zeilenumbruch */
    justify-content: center; /* Zentriert die Buttons */
    gap: 10px; /* Abstand zwischen den Buttons */
}

.button-container button {
    margin-top: 20px;
    padding: 12px 20px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
}

#clear-signature {
    background-color: red;
}

#download-pdf {
    background-color: orange;
}

#emailButton {
    background-color: green;
}

@media (max-width: 768px) {
    .button-container {
        flex-direction: column; /* Ändert die Anordnung auf Spalte bei schmalen Bildschirmen */
        align-items: center; /* Zentriert die Buttons in der Spalte */
    }
}

        button:hover {
            background-color: #0056b3;
        }
        img {
	    display: block;
            max-width: 30%;
            height: auto;
            margin:0 auto;
	    margin-bottom:20px;
            border-radius: 20px;
 	    border: 3px solid #228B22; /* Fügt einen 3px breiten, dunklen Rahmen hinzu */
	    transition: transform 0.2s ease;
        }
        img:hover {
            transform: scale(1.02); /* Bildvergrößerung bei Hover */
        }
#result {
            font-weight: bold;
            color: red;
        }
.error-message {
            color: red;
            margin-top: 15px;
            font-weight: bold;
	    margin-bottom:20px;
        }
    </style>
    </style>
</head>
<body>
 <form id="membership-form">
    <h1>Beitrittserklärung KJN</h1>
    

    
<a href="https://www.facebook.com/kjneuengruen/?locale=de_DE" target="_blank">
<img src="https://github.com/kath-jugend-neuengruen/Beitrittserklaerung-KJN/blob/main/470207678_3926429560975333_2043178117568937116_n.jpg?raw=true" alt="Logo">
</a>
	
	<h1>Alle Veranstaltungen hier</h1>
    <!-- Button zentral auf der Seite -->
    <div class="button-containers">
        <a href="KJNeuengrün_Termine2025.ics" download class="download-button">Veranstaltungskalender</a>
    </div>
   
<div class="form-group">

<textarea class="scrollable-text" readonly>
Hiermit erkläre ich meinen Beitritt zur Kath. Jugend Neuengrün-Schlegelshaid und bin gleichzeitig damit einverstanden, dass der Verein meine unten angegebenen Daten, wie z.B. Vor- und Zuname, Geburtstag usw., sowie Ehrungen/Auszeichnungen und Fotografien, veröffentlichen darf. Dieser Einwilligung kann ich jederzeit widersprechen.

Gläubiger-ID: DE50ZZZ00000431398   Mandatsreferenznummer: Mitgliedsnummer-?

Ich ermächtige die Kath. Jugend Neuengrün-Schlegelshaid den Jahresbeitrag von momentan 7.-- € (Fälligkeit: jeweils Anfang Januar) von meinem Konto mittels Lastschrift einzuziehen. Zugleich weise ich mein Kreditinstitut an, die von der Kath. Jugend Neuengrün-Schlegelshaid, auf mein Konto gezogenen Lastschriften einzulösen.

Hinweis: Ich kann innerhalb von acht Wochen, beginnend mit dem Belastungsdatum, die Erstattung des belasteten Betrages verlangen. Es gelten dabei die mit meinem Kreditinstitut vereinbarten Bedingungen.
    </textarea>

        
            <label for="vorname">Vorname:</label>
            <input type="text" id="vorname" name="vorname" required>
        
            <label for="name">Nachname:</label>
            <input type="text" id="name" name="name" required>
       
            <label for="geburtsdatum">Geburtsdatum:</label>
            <input type="date" id="geburtsdatum" name="geburtsdatum" required>
       
            <label for="strasse">Straße/Hausnummer:</label>
            <input type="text" id="strasse" name="strasse" required>
       
            <label for="plz">PLZ/Wohnort:</label>
            <input type="text" id="plz" name="plz" required>
        
            <label for="telefon">Telefon:</label>
            <input type="text" id="telefon" name="telefon" required>
       
            <label for="email">E-Mail:</label>
            <input type="email" id="email" name="email" required>
      
            <label for="kontoinhaber">Kontoinhaber:</label>
            <input type="text" id="kontoinhaber" name="kontoinhaber" required>

            <label for="iban">IBAN:    (Befindet sich auf deiner Bankkarte)</label>
            <input type="text" id="iban" name="iban" required>
            <div id="result"></div>

            <label for="bic">BIC:    (Befindet sich auf deiner Bankkarte)</label>
            <input type="text" id="bic" name="bic" required>
            
        
            <label for="ort">Aktueller Ort</label>
            <input type="text" id="ort" name="ort" required>
        </div>
<div class="form-group">
    <label for="unterschrift">Unterschrift:</label>
    <canvas id="signature-pad" style="width: 100%; border: 1px solid #000;"></canvas>
</div>
<p></p>
<div id="error-message" class="error-message"></div>

    <div class="button-container">
    <button type="button" id="clear-signature">Unterschrift löschen</button>
    <button type="button" id="download-pdf">PDF herunterladen</button>
    <button type="button" id="emailButton">KJN E-Mail senden</button>
</div>
<h1>Alles Ausfüllen -->PDF herunterladen-->Email mit PDF versenden</h1>
 </form> 
	
  <style>.pp-KCC38LHQAPBKQ{text-align:center;border:none;border-radius:0.25rem;min-width:11.625rem;padding:0 2rem;height:2.625rem;font-weight:bold;background-color:#FFD140;color:#000000;font-family:"Helvetica Neue",Arial,sans-serif;font-size:1rem;line-height:1.25rem;cursor:pointer;}</style>
<form action="https://www.paypal.com/ncp/payment/KCC38LHQAPBKQ" method="post" target="_top" style="display:inline-grid;justify-items:center;align-content:start;gap:0.5rem;">
  <input class="pp-KCC38LHQAPBKQ" type="submit" value="Jetzt Spenden" />
  <img src=https://www.paypalobjects.com/images/Debit_Credit_APM.svg alt="cards" />
  <section> Abgewickelt durch <img src="https://www.paypalobjects.com/paypal-ui/logos/svg/paypal-wordmark-color.svg" alt="paypal" style="height:0.875rem;vertical-align:middle;"/></section>
</form>
   

<script>
const canvas = document.getElementById('signature-pad');
const signaturePad = new SignaturePad(canvas);


// Function to check if all required fields are filled
function areAllFieldsFilled() {
    const requiredFields = document.querySelectorAll('#membership-form [required]');
    return Array.from(requiredFields).every(field => field.value.trim() !== '');
}

// Function to show error message
function showErrorMessage(message) {
    const errorMessageDiv = document.getElementById('error-message');
    errorMessageDiv.textContent = message;
}

// Function to hide error message
function hideErrorMessage() {
    const errorMessageDiv = document.getElementById('error-message');
    errorMessageDiv.textContent = '';
}


// Funktion zur IBAN-Überprüfung
        function validateIBAN(iban) {
            iban = iban.toUpperCase().replace(/\s/g, '');

            if (iban.length !== 22) {
                return "Ungültige IBAN-Länge.";

            }

            const rearrangedIban = iban.slice(4) + iban.slice(0, 4);

            const numericIban = rearrangedIban.split('').map(char => {
                if (/[A-Z]/.test(char)) {
                    return char.charCodeAt(0) - 55;
                } else {
                    return char;
                }
            }).join('');

            const remainder = BigInt(numericIban) % BigInt(97);

            return remainder === 1n ? "Die IBAN ist korrekt." : "Die IBAN ist nicht korrekt.";
        }

 	    

// Temporary storage for saved signature
        let savedSignatureDataURL = null;

        // Function to save signature as DataURL
        function saveSignature() {
            if (!signaturePad.isEmpty()) {
                savedSignatureDataURL = signaturePad.toDataURL();
            }
        }

        // Function to restore saved signature after resizing
        function restoreSignature() {
            if (savedSignatureDataURL) {
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.src = savedSignatureDataURL;
                img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            }
        }

        // Clear signature button event listener
        document.getElementById('clear-signature').addEventListener('click', () => {
            signaturePad.clear();
            savedSignatureDataURL = null;
        });

 function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const context = canvas.getContext("2d");
    const savedData = signaturePad.toDataURL(); // Speichere Signatur
    
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.width/2;
    context.scale(ratio, ratio);

    // Lade gespeicherte Signatur, falls vorhanden
    if (savedData) {
        const image = new Image();
        image.src = savedData;
        image.onload = () => context.drawImage(image, 0, 0, canvas.width / ratio, canvas.height / ratio);
    }
}

 // Resize and save signature on resize and scroll events
        window.addEventListener("resize", resizeCanvas);
        window.addEventListener("scroll", saveSignature);
        resizeCanvas(); // Initial setup




        document.getElementById('download-pdf').addEventListener('click', async () => {
            
            const formData = new FormData(document.getElementById('membership-form'));

	    const ibanToCheck = document.getElementById('iban').value;
            const result = validateIBAN(ibanToCheck);
            document.getElementById('result').innerText = result; // Ergebnis anzeigen

if (!areAllFieldsFilled()) {
        showErrorMessage('Bitte füllen Sie alle erforderlichen Felder aus.');
        return; // Stop execution if fields are not filled
    }
 hideErrorMessage(); // Hide error message if fields are filled
          
  if (result === "Die IBAN ist korrekt.") {

// Formulardaten sammeln
            const membershipformData = {
                vorname: document.getElementById('vorname').value,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
		iban: document.getElementById('iban').value,
		geb: document.getElementById('geburtsdatum').value,
                strasse: document.getElementById('strasse').value,
                ort: document.getElementById('plz').value,
		tel: document.getElementById('telefon').value
            };

            // Sende Daten an das Google Apps Script
            fetch('https://script.google.com/macros/s/AKfycbw-AxO7BemF2LJdX2vWs2nEYu9WAA5y9769DOEX21MSEzDweEWMNvII_nfg_ibOIkWKqg/exec', {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(membershipformData)
            })


         const { PDFDocument, rgb } = PDFLib;
            const pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage([600, 800]);

	// Aktuelles Datum im Format dd.mm.yyyy
const currentDate = new Date();
const formattedDate = `${currentDate.getDate().toString().padStart(2, '0')}.${(currentDate.getMonth() + 1).toString().padStart(2, '0')}.${currentDate.getFullYear()}`;

// Definierte Ränder für das gesamte Dokument
            const marginLeft = 50;
            const marginTop = 750;
            const fieldspace = 255; //Abstand zwischen den bearbeitbaren Feldern
            const textWidth = page.getWidth() - 2 * marginLeft; // Breite des Textbereichs
            let currentY = marginTop;

            // Titel und Text für die Beitrittserklärung
            page.drawText('Kath. Jugend Neuengrün-Schlegelshaid', {
                x: page.getWidth() / 2 - 150,
                y: currentY,
                size: 16,
                color: rgb(0, 0, 0),
                font: await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold)
            });

            currentY -= 20; // Abstand nach Titel
            page.drawText('Beitrittserklärung', {
                x: page.getWidth() / 2 - 70,
                y: currentY,
                size: 14,
                color: rgb(0, 0, 0),
                font: await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold)
            });

            currentY -= 20; // Abstand nach Untertitel
            page.drawText(`Hiermit erkläre ich meinen Beitritt zur Kath. Jugend Neuengrün-Schlegelshaid und bin gleichzeitig damit einverstanden, dass der Verein meine unten angegebenen Daten, wie z.B. Vor- und Zuname, Geburtstag usw., sowie Ehrungen/Auszeichnungen und Fotografien, veröffentlichen darf. Dieser Einwilligung kann ich jederzeit widersprechen.`, {
                x: marginLeft,
                y: currentY,
                size: 12,
                color: rgb(0, 0, 0),
                maxWidth: textWidth
            });

            // Platz für persönliche Daten
            currentY -= 110;
            const fields = [
                { name: 'Vorname', x: marginLeft, y: currentY, b:0, value: formData.get('vorname') },
                { name: 'Name', x: marginLeft, y: currentY - 30, b:0, value: formData.get('name') },
                { name: 'Geburtsdatum', x: marginLeft, y: currentY - 60, b:0, value: formData.get('geburtsdatum') },
                { name: 'Straße/Haus-Nr', x: marginLeft, y: currentY - 90, b:0, value: formData.get('strasse') },
                { name: 'PLZ/Wohnort', x: marginLeft, y: currentY - 120, b:0, value: formData.get('plz') },
                { name: 'Telefon', x: marginLeft + fieldspace, y: currentY, b:25, value: formData.get('telefon') },
                { name: 'E-Mail', x: marginLeft + fieldspace, y: currentY - 30, b:25, value: formData.get('email') }
            ];

           // Füge bearbeitbare Textfelder hinzu
for (const field of fields) {
    const inputField = pdfDoc.getForm().createTextField(field.name);
    inputField.addToPage(page, {
        x: field.x + 95 - field.b, // Position für das Textfeld
        y: field.y,
        width: 140 + field.b*2,
        height: 20,
    });

    // Zeichne den Namen des Feldes
    page.drawText(field.name, {
        x: field.x,
        y: field.y + 5,
        size: 12,
        color: rgb(0, 0, 0),
        font: await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold)
    });

    // Setze die Textgröße und den Wert des Feldes
    inputField.setFontSize(12);
    inputField.setText(field.value);
}



 currentY -= 170; // Abstand nach Titel
            page.drawText('SEPA-Lastschriftmandat', {
                x: page.getWidth() / 2 - 70,
                y: currentY,
                size: 14,
                color: rgb(0, 0, 0),
                font: await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold)
            });

currentY -= 20; // Abstand nach Untertitel
            page.drawText(`Gläubiger-ID: DE50ZZZ00000431398   Mandatsreferenznummer: Mitgliedsnummer

Ich ermächtige die Kath. Jugend Neuengrün-Schlegelshaid den Jahresbeitrag von momentan 7.-- € (Fälligkeit: jeweils Anfang Januar) von meinem Konto mittels Lastschrift einzuziehen. Zugleich weise ich mein Kreditinstitut an, die von der Kath. Jugend Neuengrün-Schlegelshaid, auf mein Konto gezogenen Lastschriften einzulösen.

Hinweis: Ich kann innerhalb von acht Wochen, beginnend mit dem Belastungsdatum, die Erstattung des belasteten Betrages verlangen. Es gelten dabei die mit meinem Kreditinstitut vereinbarten Bedingungen.`, {
                x: marginLeft,
                y: currentY,
                size: 12,
                color: rgb(0, 0, 0),
                maxWidth: textWidth
            });
            // Platz für Bankinformationen
            currentY -= 200;
            const bankFields = [
                { name: 'Kontoinhaber', x: marginLeft, y: currentY, e: 0, value: formData.get('kontoinhaber') },
                { name: 'IBAN', x: marginLeft , y: currentY - 30, e: 0, value: formData.get('iban') },
                { name: 'BIC', x: marginLeft + fieldspace , y: currentY, e: 70, value: formData.get('bic') },
		{ name: 'Ort', x: marginLeft , y: currentY - 110, e: 0, value: formData.get('ort')},
{ name: 'Datum', x: marginLeft, y: currentY - 140, e: 0, value: formattedDate }
            ];

            // Füge bearbeitbare Textfelder hinzu
for (const field of bankFields) {
    const inputField = pdfDoc.getForm().createTextField(field.name);
    inputField.addToPage(page, {
        x: field.x + 100, // Position für das Textfeld
        y: field.y,
        width: 175,
        height: 20,
    });

    // Zeichne den Namen des Feldes
    page.drawText(field.name, {
        x: field.x + field.e,
        y: field.y + 5,
        size: 14,
        color: rgb(0, 0, 0),
        font: await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold)
    });

    // Setze die Textgröße und den Wert des Feldes
    inputField.setFontSize(12);
    inputField.setText(field.value);
}

// Prüfen, ob die Unterschrift gezeichnet wurde
if (!signaturePad.isEmpty()) {

    // Funktion zum Umwandeln von DataURL zu ArrayBuffer
    function dataURLToArrayBuffer(dataURL) {
        const binaryString = atob(dataURL.split(',')[1]);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    // Abrufen der DataURL von signaturePad
    const signatureImage = signaturePad.toDataURL();

    // Umwandeln der DataURL in ein ArrayBuffer
    const pngImageBytes = dataURLToArrayBuffer(signatureImage);

    try {
        // Einbetten des PNG in das PDF-Dokument
        const pngImage = await pdfDoc.embedPng(pngImageBytes);
        console.log('PNG erfolgreich eingebettet:', pngImage);

        // Skalieren des PNG-Bildes auf 50 % der Originalgröße
        const pngDims = pngImage.scale(0.5);  // Hier kannst du die Skalierung nach Bedarf anpassen

        // Zeichnen der Unterschrift (PNG-Bild) auf der gewünschten Position
        page.drawImage(pngImage, {
            x: 340,  // X-Position auf der Seite
            y: 40,  // Y-Position auf der Seite
            width: 250,   // Breite des skalierten Bildes
            height: 125  // Höhe des skalierten Bildes
        });

    
} catch (error) {
        console.error('Fehler beim Einbetten des PNG-Bildes:', error);
    }
} else {
    console.log('Keine Unterschrift gefunden.');
}

const xPosition = 350;
const yPosition = 60;

// Linie zeichnen
page.drawLine({
    start: { x: xPosition, y: yPosition + 10 }, // Linie oberhalb des Textes
    end: { x: xPosition + 200, y: yPosition + 10 }, // 100 Pixel lange Linie
    thickness: 1,
    color: rgb(0, 0, 0),
});

// Text "Unterschrift" unter der Linie zeichnen
page.drawText("Unterschrift", {
    x: xPosition,
    y: yPosition,
    size: 8,
    color: rgb(0, 0, 0),
});

const vorname = formData.get('vorname'); // Annahme, dass formData die Daten enthält
const name = formData.get('name');


            // PDF speichern
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `Beitrittserklaerung-${vorname || 'Vorname'}-${name || 'Nachname'}-${formattedDate}.pdf`; // Mit Datum
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

}



		
        });





document.getElementById('emailButton').addEventListener('click', function() {

if (!areAllFieldsFilled()) {
        showErrorMessage('Bitte füllen Sie alle erforderlichen Felder aus.');
        return; // Stop execution if fields are not filled
    }
 hideErrorMessage(); // Hide error message if fields are filled

const ibanToCheck = document.getElementById('iban').value;
            const result = validateIBAN(ibanToCheck);
            document.getElementById('result').innerText = result; // Ergebnis anzeigen

if (result === "Die IBAN ist korrekt.") {

const vorname = document.getElementById('vorname').value; // oder wo auch immer du die Werte herbekommst
const name = document.getElementById('name').value;

            const email = "christopher@online-jack.de"; // Zieladresse hier eintragen
            const subject = "Beitrittserklärung";
            const body = `
**${vorname || 'Vorname'}, Bitte vergessen Sie nicht, die automatisch erstellte PDF-Datei beizufügen!**
 
Hallo liebes KJN-Team,

anbei finden Sie meine Beitrittserklärung im PDF-Format. 
Ich freue mich auf eine positive Rückmeldung.

Mit freundlichen Grüßen, 
${vorname || 'Vorname'} ${name || 'Nachname'}`;


            // E-Mail-Link erstellen
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}
        });

	

    </script>

</body>
</html>
